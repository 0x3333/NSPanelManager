{% extends 'base.html' %}

{% block head %}
{% load static %}
  <script src="{% static 'question.js' %}?refresh={% now 'U' %}"></script>
  <script src="{% static 'modal-select-entity.js' %}?refresh={% now 'U' %}"></script>
  <script>
    function select_new_weather_entity() {
      var types = {
        "home_assistant_type_filter": JSON.stringify([
          "weather"
        ])
      };
      select_new_entity(types, select_weather_entity);
    }

    function select_weather_entity(element) {
      $(".modal").removeClass("is-active");
      if($(this).data("type") == "home_assistant") {
        $("#weather_home_assistant_entity").val($(this).data("entity_id"));
        $("#weather_entity").val($(this).text());
        $("#weather_type").val("home_assistant");
      } else {
        var items = $(this).data("items");
        var options = [];
        items.forEach(item => {
          options.push({text: item, value: item});
        });

        select_openhab_items("Select weather items", options, [
          {text: "Current weather item", id: "current_weather_item"},
          {text: "Forcast weather item", id: "forcast_weather_item"}
        ], openhab_weather_items_selected);
      }
    }

    function select_new_sun_entity() {
      var types = {
        "home_assistant_type_filter": JSON.stringify([
          "sun"
        ])
      };
      select_new_entity(types, (element) => {
        $(".modal").removeClass("is-active");
        $("#sun_entity").val($(element.currentTarget).data("entity_id"));
      });
    }

    function openhab_weather_items_selected(data) {
      $(".modal").removeClass("is-active");
      $("#weather_type").val("openhab");
      $("#weather_openhab_current_weather_item").val(data["current_weather_item"]);
      $("#weather_openhab_forcast_weather_item").val(data["forcast_weather_item"]);
      $("#weather_entity").val(data["current_weather_item"] + ", " + data["forcast_weather_item"]);
    }

    $(document).ready(() => {
      var types = {
        "home_assistant_type_filter": JSON.stringify([
          "weather"
        ])
      };
      $.get("/api/get_all_available_entities", types, function (data) {
        data.home_assistant_entities.forEach((entity) => {
          $("#weather_entity").append($('<option>', {
            value: "homeassistant," + entity.entity_id,
            text: entity.label
          }));
        });

        data.openhab_entities.forEach((entity) => {
          $("#weather_entity").append($('<option>', {
            value: "openhab," + entity.entity_id,
            text: entity.label
          }));
        });
        data.manual_entities.forEach((entity) => {
          $("#weather_entity").append($('<option>', {
            value: "manual," + entity.entity_id,
            text: entity.label
          }));
        });
      });
    });
  </script>
{% endblock %}

{% block content %}
{% load mathfilters %}
{% include 'modal-select-entity.html' %}

<div class="level">
  <div class="level-left">
    <div class="level-item">
      <h2 class="title is-4">Weather & Time</h2>
    </div>
  </div>
</div>
<div>
  <form method="POST" action="{% url 'weather_and_time' %}">
    {% csrf_token %}
    <div class="box">
      <div class="field">
        <label class="label">Date format<span class="question">
          <span class="icon question_icon">
            <i class="mdi mdi-information has-text-info"></i>
          </span>
          <div class="question_help_text notification is-info is-light">
            The format of the date on the NSPanel. This is set using the strftime function. See available formatting for all options.
          </div>
        </label>
        <div class="control">
          <input class="input" type="text" name="date_format" id="date_format"
              placeholder="strftime format" value="{{ date_format }}">
        </div>
        <div class="control mt-2">
          <a href="https://cplusplus.com/reference/ctime/strftime/" target="_blank" class="button is-link">See available formatting</a>
        </div>
      </div>

      <div class="field">
        <label class="label">Weather entity<span class="question">
          <span class="icon question_icon">
            <i class="mdi mdi-information has-text-info"></i>
          </span>
          <div class="question_help_text notification is-info is-light">
            The entity you wish to use for the weather information on the screensaver.
          </div>
        </label>
        <div class="control">
          <input type="hidden" name="weather_type" id="weather_type" value="{{ weather_type }}">
          <input type="hidden" name="weather_home_assistant_entity" id="weather_home_assistant_entity" value="{{ weather_home_assistant_weather_entity }}">
          <input type="hidden" name="weather_openhab_current_weather_item" id="weather_openhab_current_weather_item" value="{{ weather_openhab_current_weather_item }}">
          <input type="hidden" name="weather_openhab_forcast_weather_item" id="weather_openhab_forcast_weather_item" value="{{ weather_openhab_forcast_weather_item }}">
          <input class="input" type="text" name="weather_entity" id="weather_entity" readonly value="{{ weather_entity }}">
          <div class="control mt-2">
            <a class="button is-primary" onclick="select_new_weather_entity();">Select weather entity</a>
          </div>
        </div>
      </div>

      <div class="field">
        <label class="label">Home Assistant sun<span class="question">
          <span class="icon question_icon">
            <i class="mdi mdi-information has-text-info"></i>
          </span>
          <div class="question_help_text notification is-info is-light">
            The sun entity in Home Assistant is used to get sunrise/sunset information. This is only needed if you are using Home Assistant and can be safely ignored if using OpenHAB.
          </div>
        </label>
        <div class="control">
          <input class="input" type="text" name="sun_entity" id="sun_entity" readonly value="{{ sun_entity }}">
          <div class="control mt-2">
            <a class="button is-primary" onclick="select_new_sun_entity();">Select sun entity</a>
            <a class="button is-link" href="https://www.home-assistant.io/integrations/sun/">More information</a>
          </div>
        </div>
      </div>

      <div class="field">
      <label class="checkbox">
          {% if clock_us_style == "True" %}
              <input type="checkbox" name="clock_us_style" checked>
          {% else %}
              <input type="checkbox" name="clock_us_style">
          {% endif %}
          Show the time with AM/PM
          <span class="question">
            <span class="icon question_icon">
              <i class="mdi mdi-information has-text-info"></i>
            </span>
            <div class="question_help_text notification is-info is-light">
              Wether or not to use 24 or 12 hour clock. Enabling this will show the clock with AM and PM.
            </div>
          </span>
      </label>
      </div>
      <div class="field">
        <label class="checkbox">
            {% if use_farenheit == "True" %}
                <input type="checkbox" name="use_farenheit" checked>
            {% else %}
                <input type="checkbox" name="use_farenheit">
            {% endif %}
            Use farenheit
            <span class="question">
              <span class="icon question_icon">
                <i class="mdi mdi-information has-text-info"></i>
              </span>
              <div class="question_help_text notification is-info is-light">
                Wether to report temperature in farenheit. Default: Unchecked = report in celcius.
              </div>
            </span>
        </label>
      </div>
    </div>

    <!-- Add 1rem of padding to bottom to prevent a white bar appering on the bottom of the page -->
    <div class="level mt-4" style="padding-bottom: 1rem;">
      <div class="level-left">
        <div class="buttons is-right">
        </div>
      </div>
      <div class="level-right">
        <div class="buttons">
          <button class="button is-success" type="submit" id="save_button">Save</button>
        </div>
      </div>
    </div>
  </form>
</div>
{% endblock %}
